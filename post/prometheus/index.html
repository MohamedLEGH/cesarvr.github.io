<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <title>Creating Your Own Istio (Part 1) - Nube</title>
  
  <meta name="description" content="Some days ago, I was watching this video about Istio in Google I/O and while watching it, I started to think on how to do it or how they achieve this or that feature. So, as an excuse to learn how to build containers that collaborate with each other, I decided to replicate some of the functionalities I saw in that video for fun and at the same time to learn how I can encapsulate behaviour like I usually do with objects, but with containers.

">
  <meta name="author" content="">
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i" rel="stylesheet">
  <link href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/atom-one-dark.min.css" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet">
  
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">
  <link rel="icon" href="/img/favicon.ico">
  
  <meta name="generator" content="Hugo 0.48">
  
  <link rel="alternate" type="application/atom+xml" href="/index.xml" title="Nube">
  
</head>
<body class="single">
  <header class="header">
    
    <p class="title"><a href="/">Nube</a></p>
    
    <button class="menu-toggle" type="button"></button>
    <nav class="menu">
      <ul>
        
        
        <li class="">
          <a href="categories/">Categories</a>
        </li>
        
        <li class="">
          <a href="/about/">About</a>
        </li>
        
        <li class="">
          <a href="https://github.com/cesarvr">Code</a>
        </li>
        
        <li class="">
          <a href="/post/">Writing</a>
        </li>
        
      </ul>
    </nav>
  </header>
  <main class="main">

<article class="post post-view">
  <header class="post-header">
    <h1 class="post-title">Creating Your Own Istio (Part 1)</h1>
    <p class="post-meta">2018.9.19</p>
  </header>
  <div class="post-content"><p>Some days ago, I was watching this video about Istio in Google I/O and while watching it, I started to think on how to do it or how they achieve this or that feature. So, as an excuse to learn how to build containers that collaborate with each other, I decided to replicate some of the functionalities I saw in that video for fun and at the same time to learn how I can encapsulate behaviour like I usually do with objects, but with containers.</p>

<p></p>

<p>A good example of this separation of concerns can be found in the so-called <em>&ldquo;service mesh&rdquo;</em> frameworks like Istio, Linkdr?, Prometheus, etc. Where you have some application running in a container like a typical Restful web service and you add another container that enhance the functionality of that application. For me it can be thought as the equivalent to an object <a href="https://en.wikipedia.org/wiki/Decorator_pattern">decorator</a> in object oriented programming.</p>

<p>To understand how to create this type of applications, I decided to deploy a dumb server and enhance/decorate this server with new functionalities following the open close principle or in other words, which said that our functionality should be open for extention and close for modification. Let&rsquo;s see to what extend this can be achieved with containers.</p>

<p>But before adding any functionality, first we need to learn how we setup our application to run multiple containers and more important how we can handle communication between the two.</p>

<h1 id="simple-web-server">Simple Web Server</h1>

<p>We are going to create a dumb web server using Python SimpleHTTPServer module which is a command line tool to serve the content of an arbitrary folder. The purpose of using something like this is to demonstrate how we can enhance later the functionality of this process by appending our &ldquo;decorator/ambassador&rdquo; container.</p>

<p>Usage example:</p>

<pre><code class="language-sh"> cd ~/some-folder 
 python -m http.server 8080 # Now the content of &lt;some-folder&gt; is available in localhost:8080 
</code></pre>

<h2 id="deploy">Deploy</h2>

<p>We got the web server, now we need to deploy it into our Kubernetes/OpenShift cluster. The template would look something this:</p>

<pre><code class="language-sh">apiVersion: v1
kind: Pod
metadata:
  name: python-pod
  labels:
    app: python
spec:
  containers:
  - name: python
    image: python
    command: [&quot;sh&quot;, &quot;-c&quot;, &quot;cd /tmp/ &amp;&amp; git clone https://github.com/cesarvr/demos-webgl demos &amp;&amp; cd demos/static/ &amp;&amp; python -m http.server 8080&quot;]
    ports:
    - containerPort: 8080
</code></pre>

<p>To run this server we&rsquo;ll use a python base image which come with Python 3. Then we define the command we want to run inside our container, that goes as follow:</p>

<pre><code class="language-sh">cd /tmp/    
</code></pre>

<p>Jump to the folder temporal folder, Linux systems offer this directory for temporary files, I&rsquo;m going to use this one because it doesn&rsquo;t require any priviledge.</p>

<pre><code class="language-sh">git clone https://github.com/cesarvr/demos-webgl demos  
</code></pre>

<p>Then I&rsquo;ll clone the static HTML website and save it inside a folder called demos.</p>

<pre><code class="language-sh">cd demos/static/     
python -m http.server 8080   
</code></pre>

<p>Jump into the static sub-folder and run the Python server module, if you want to closer look to the folder structure here is the <a href="https://github.com/cesarvr/demos-webgl">repository.</a></p>

<p>We call this template <a href="https://gist.github.com/cesarvr/b1ce3b5098292fd01b42b13697301b17">python.yml</a> and we feed it to the oc-client like this:</p>

<pre><code class="language-sh">oc create -f python.yml

# or this way it will pick the template from the github.gist.
oc create -f https://gist.githubusercontent.com/cesarvr/b1ce3b5098292fd01b42b13697301b17/raw/2e730e761b7ac99ac6b8186caac1f0c31e10063f/python.yml
</code></pre>

<p>Voila!, in just a few seconds our web server should be running in our cluster. Now let&rsquo;s send some traffic, by creating a Service.</p>

<pre><code class="language-sh"> oc create service loadbalancer python-pod --tcp=8080:8080
</code></pre>

<p>We create the Service called python-pod, the name match the name of the pod this way the traffic is sended directly to the pod. Only step left is to expose that Service, which mean basically to open it to receive traffic from outside of the cluster.</p>

<pre><code class="language-sh">oc expose svc python-pod 

oc get route

NAME         HOST/PORT                                                      PATH      SERVICES    
my-service   python-pod-web-apps.7e14.starter-us-west-2.openshiftapps.com             my-service   8080                    None

curl python-pod-web-apps.7e14.starter-us-west-2.openshiftapps.com
# HTML from the static site...
</code></pre>

<p>If you never hear before the concept of pod, service or router you can follow this <a href="https://github.com/cesarvr/Openshift">guide</a> for begginers.</p>

<h1 id="side-container">Side Container</h1>

<h2 id="concepts">Concepts</h2>

<p>The trick of collaboration between containers is that the <strong>pod</strong> behaves like a container of containers, meaning we can place there more than one container, and containers running inside the pod can share resources like network namespace (port mapping) and they can share mounting points (folders).</p>

<h2 id="containers-as-objects">Containers as objects</h2>

<p>In object oriented programming (as concieved by Alan Kay) objects collaborate with each other by what he call messages (also known as methods) :</p>

<pre><code class="language-cpp">Class A { 
 void do_something() {}; 
};

A a; 

# passing a message do_something to A
a.do_something();  # he knows what to do! 

a.clear(); # Fail!
</code></pre>

<p>The question is, can we use the same metaphor with containers ? The answer is why not, but we need a little bit more inmagination. To collaborate with each other we can use (as mentioned above) various methods we can use sockets or the filesystem. So basically right now our Python application (using the object oriented analogy) is accepting messages using the port 8080.</p>

<pre><code class="language-sh">oc rsh python-pod # loggin inside our container. 

curl 0.0.0.0:8080/index.html   

#&lt;DOCTYPE...&gt;    
</code></pre>

<p>Think about it, this is not that different from the object counterpart, we can think of this container as a black box that receive a message <code>/GET index.html</code> and give us a bunch of strings back. Contiuing with the object oriented analogy we need to study how we communicate each object or container.</p>

<h1 id="from-theory-to-practice">From Theory to Practice</h1>

<h2 id="adding-more-containers">Adding more containers</h2>

<p>To demonstrate how containers can talk to each other inside the <em>pod</em>, we are going to add to our existing template a simple container running a shell, this way we can perform some experiments.</p>

<pre><code class="language-yaml">- name: sidecar   
  image: busybox
  command: [&quot;sh&quot;, &quot;-c&quot;, &quot;sleep 3600&quot;]
</code></pre>

<p>This block will create a container called <em>sidecar</em>, we are going to use a base image from busybox (Thinking about OOP again, we can even think of this image as a base class) which include a ssh and the sleep command. Then in the command section we are going to execute the sleep command for 3.6K seconds, this will keep the image alive, so we can run try some ideas.</p>

<p>Our final template will look something like this:</p>

<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: python-pod
  labels:
    app: python
spec:
  containers:
  - name: python
    image: python
    command: [&quot;sh&quot;, &quot;-c&quot;, &quot;cd /tmp/ &amp;&amp; git clone https://github.com/cesarvr/demos-webgl demos &amp;&amp; cd demos/static/ &amp;&amp; python -m http.server 8080&quot;]
    ports:
    - containerPort: 8080
  - name: sidecar   
    image: busybox
    command: [&quot;sh&quot;, &quot;-c&quot;, &quot;sleep 3600&quot;]
</code></pre>

<p>The only difference here is that we just added this new container at the bottom.</p>

<pre><code class="language-sh">oc delete pod python-pod
oc create -f python.yml
</code></pre>

<p>We delete the existing pods, and recreate them with our new template.</p>

<p>### Alternative</p>

<p>You can also save that step by editing the Pod template remotely:</p>

<pre><code class="language-sh">oc edit pod python-pod
</code></pre>

<h2 id="messaging">Messaging</h2>

<p>Now that our two containers is running, let see how they share messages. Let&rsquo;s login to our newly created container <em>sidecar</em>.</p>

<pre><code class="language-sh">oc rsh -c sidecar python-pod
</code></pre>

<p>As mentioned before this two containers share the same network namespace, to send and receive messages from the container running in our same area by just asking something in port 8080.</p>

<pre><code class="language-sh">wget 0.0.0.0:8080
# index.html           100% |*****************|   504  0:00:00 ETA
</code></pre>

<p>Nice, this message is comming back from our python server, which is running side-by-side. Now we are ready to develop our decorator/ambassador container. In the next article we are going to write the program to enhance the capabilities of the python server, now that we prove that we can talk to it.</p></div>
  <footer class="post-footer">
    
    <ul class="post-tags">
      
      <li><a href="/tags/openshift/">openshift</a></li>
      
      <li><a href="/tags/imagestream/">imagestream</a></li>
      
    </ul>
    
  </footer>
  
  
  
  <div id="disqus_thread"></div>
  <script>
    var disqus_shortname = 'cesar';
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
  
  
</article>
</main>
<footer class="footer">
  <span>&copy; 2018 Nube</span>
  <span>&middot;</span>
  <span>Powered by <a href="https://gohugo.io/" target="_blank">Hugo️️</a>️</span>
  <span>&middot;</span>
  <span>Designed by <a href="http://21beats.com/" target="_blank">️21beats️</a>️</span>
</footer>
<script src="https://cdn.bootcss.com/instantclick/3.0.1/instantclick.min.js" data-no-instant></script>
<script data-no-instant>InstantClick.init();</script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js" data-no-instant></script>
<script data-no-instant>
  hljs.initHighlightingOnLoad();
  addMenuListener();
  InstantClick.on('change', function() {
    var blocks = document.querySelectorAll('pre code');
    for (var i = 0; i < blocks.length; i++) {
      hljs.highlightBlock(blocks[i]);
    }
    addMenuListener();
  });
  function addMenuListener() {
    var $toggle = document.querySelector('.menu-toggle');
    var $body = document.querySelector('body');
    $toggle.addEventListener('click', function() {
      $body.classList.toggle('noscroll');
    }, false);
  }
</script>
</body>
</html>

